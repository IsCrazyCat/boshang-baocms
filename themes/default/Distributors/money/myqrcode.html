<include file="public:header"/>
	<header class="top-fixed bg-yellow bg-inverse">
		<div class="top-back">
			<a class="top-addr" href="<{:U('shop/detail',array('shop_id'=>$shop['shop_id']))}>"><i class="icon-angle-left"></i></a>
		</div>
		<div class="top-title">
			<{$shop.shop_name}>
		</div>
		
	</header>
	
	<script>
		$(document).ready(function () {
			$("#share-box").hide();
			$("#share-btn").click(function () {
				$("#share-box").toggle();
				$('html,body').animate({scrollTop:0}, 'slow');
			});
			$("#mui-card-close").click(function () {
				$("#share-box").hide();
			});
		});
	</script>
	
                
               
	<div class="container">

		<div class="padding-large">
            <div id="qr_container" style="margin:auto; position:relative; width:100%; text-align:center; display:none" ></div>
            <div id="imgDiv" style="margin:auto; position:relative; width:100%; text-align:center;"></div>
			
		</div>
		<p class="text-center">微信里长按识别二维码</p>

	</div>
 
 
<script src="/my/js/jquery.qrcode.min.js"></script>
 
 
    
    

<div id="imgDiv"></div>

<script>
	$(document).ready(function(){
    // 点击生成二维码
   
        /*如果已生成过二维码，则删除二维码img图片和canvas，重新生成；反之，则直接生成二维码*/
        
    createQr();
        
  
    // 生成二维码
    function createQr(){
        document.createElement('canvas').getContext('2d');
        var valText = "http://www.blklube.com/mcenter/money/myindex/shop_id/<{$shop.shop_id}>";
 
        // 采用正则表达式判断输入的内容是否是中文
        var reg=/^[\u0391-\uFFE5]+$/; 
         if(valText!=""&&!reg.test(valText)){ 
            // 如果不是中文，直接将输入的内容转换成二维码
            $('#qr_container').qrcode({render:"canvas",height:280, width:280,correctLevel:0,text:valText});
         }else{
            // 如果是中文，直接将输入的内容字符串转换成UTF-8，然后再转换成二维码
            $('#qr_container').qrcode({render:"canvas",height:280, width:280,correctLevel:0,text:utf16to8(valText)});
         }
 
        //获取网页中的canvas对象
        var mycanvas1=document.getElementsByTagName('canvas')[0];
 
        //将转换后的img标签插入到html中
        var img = convertCanvasToImage(mycanvas1);
       $('#imgDiv').append(img);//imgDiv表示你要插入的容器id
    }
 
    // 字符编码
    function utf16to8(str) {  
        var out, i, len, c;  
        out = "";  
        len = str.length;  
        for(i = 0; i < len; i++) {  
        c = str.charCodeAt(i);  
        if ((c >= 0x0001) && (c <= 0x007F)) {  
            out += str.charAt(i);  
        } else if (c > 0x07FF) {  
            out += String.fromCharCode(0xE0 | ((c >> 12) & 0x0F));  
            out += String.fromCharCode(0x80 | ((c >>  6) & 0x3F));  
            out += String.fromCharCode(0x80 | ((c >>  0) & 0x3F));  
        } else {  
            out += String.fromCharCode(0xC0 | ((c >>  6) & 0x1F));  
            out += String.fromCharCode(0x80 | ((c >>  0) & 0x3F));  
        }  
        }  
        return out;  
    }
 
    //从canvas中提取图片image
    function convertCanvasToImage(canvas) {
        //新Image对象，可以理解为DOM
        var image = new Image();
        // canvas.toDataURL 返回的是一串Base64编码的URL
        // 指定格式PNG
        image.src = canvas.toDataURL("image/png");
        return image;
    }
});
	
</script>
<style type="text/css">
.sc_ico {
	background-image:url(/themes/default/Mobile/index/img/fenlei.png) no-repeat 0px 0px;
}
.sc_ico {
	background-image:url(/themes/default/Mobile/index/img/gwc.png) no-repeat 0px 0px;
}
</style>


<if condition="$CONFIG[other][footer] eq 1">
<footer class="foot-fixed">

<a  style="width:33.333%" class="foot-item <if condition="($ctl eq 'jifen') AND ($act neq 'more')">active</if>" href="<{:U('jifen/index')}>">		
<span class="icon icon-cart-plus"></span>
<span class="foot-label">兑换</span>
</a>


<a  style="width:33.333%"  class="foot-item <eq name="ctl" value="shop">active</eq>" href="<{:U('shop/index')}>">			
<span class="icon sc_ico ">
<if condition="($ctl eq 'shop') ">
<img src="/themes/default/Mobile/index/img/fenlei-red.png" width="24" />
<else />
<img src="/themes/default/Mobile/index/img/fenlei.png" width="24" />
</if>
</span><span class="foot-label">门店</span></a>



<a style="width:33.333%"  class="foot-item <eq name="ctl" value="mcenter">active</eq>" href="<{:U('mcenter/index/index')}>">			
<span class="icon icon-user"></span><span class="foot-label">我的</span></a>



</footer>
<else/>
</if>

<iframe id="x-frame" name="x-frame" style="display:none;"></iframe>

<script> var BAO_PUBLIC = '__PUBLIC__'; var BAO_ROOT = '__ROOT__'; var BAO_SURL = '<{$CONFIG['site']['host']}>__SELF__'</script>
<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js" type="text/javascript"></script>
<script>
$(function(){
	var newurl = BAO_SURL.replace(/\?\S+/,'');
	var stitle = "<{$nickname}>在<{$detail.shop_name}>消费，排队获得惊喜，大家赶快来参与呀！"; 
	var sdesc = '我的在<{$detail.shop_name}>消费，排队获得惊喜，大家赶快来参与呀！'; 
	var surl = newurl+'?fuid=<{:getuid()}>';	
	var catchpic = $('img');
	var lcatchpic = "<{$CONFIG['site']['host']}>" + $('img').eq(0).attr("src");
	$('img').each(function(){
		if($(this).width() >= 60){
			lcatchpic = $(this).attr("src");
			if(lcatchpic.indexOf("http://") < 0){
				lcatchpic = "<{$CONFIG['site']['host']}>" + lcatchpic;
			}
			return false;
		};
	});
	
	var spic = "<{$CONFIG['site']['host']}>"+BAO_PUBLIC+'/img/logo.jpg';
	if(catchpic.length > 0){
		spic = lcatchpic;
		
	}
	console.log(lcatchpic);
	//alert(spic);
	wx.config({
	debug: false,
	appId: '<{$signPackage.appId}>',
    timestamp: '<{$signPackage.timestamp}>',
    nonceStr: '<{$signPackage.nonceStr}>',
    signature: '<{$signPackage.signature}>',
	jsApiList: [
	'checkJsApi',
	'onMenuShareTimeline',
	'onMenuShareAppMessage',
	'onMenuShareQQ',
	'onMenuShareWeibo',
	'onMenuShareQZone'
	]
	});
	wx.ready(function(){
		wx.onMenuShareTimeline({
			title: stitle, 
			desc: sdesc, // 分享描述
			link: surl, 
			imgUrl: spic,
			success: function () { 
				alert("分享成功!");

			},
			cancel: function () { 
				alert("分享失败!");
			}
		});
		wx.onMenuShareAppMessage({		
			title: stitle,
			desc: sdesc, // 分享描述
			link: surl, 
			imgUrl: spic,
			type: '', // 分享类型,music、video或link，不填默认为link
			dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
			success: function () { 
				alert("分享成功!");

			},
			cancel: function () { 
				alert("分享失败!");
			}
		});
		wx.onMenuShareQQ({
			title: stitle,
			desc: sdesc, // 分享描述
			link: surl, 
			imgUrl: spic,
			success: function () { 
			   alert("分享成功!");

			},
			cancel: function () { 
			   alert("分享失败!");
			}
		});
		wx.onMenuShareWeibo({
			title: stitle,
			desc: sdesc, // 分享描述
			link: surl, 
			imgUrl: spic,
			success: function () { 
			  alert("分享成功!");

			},
			cancel: function () { 
				alert("分享失败!");
			}
		});	
		wx.onMenuShareQZone({
			title: stitle,
			desc: sdesc, // 分享描述
			link: surl, 
			imgUrl: spic,
			success: function () { 
			   alert("分享成功!");

			},
			cancel: function () { 
				alert("分享失败!");
			}
		});	
	});
})	
</script>		    
	

</body>
</html>
    
